name: FE CI/CD (S3 + CloudFront)

on:
  pull_request:
    branches: [ develop, main ]   # PR: build only
  push:
    branches: [ develop, main ]   # push: build + deploy
  workflow_dispatch:

concurrency:
  group: fe-s3-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"

jobs:
  # -------------------------
  # PR: build only
  # -------------------------
  pr-build:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install
        run: npm ci --prefer-offline --no-audit --progress=false

      - name: Build (PR uses DEV vars)
        env:
          VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL_DEV }}
          VITE_OAUTH2_BASE_URL: ${{ vars.VITE_OAUTH2_BASE_URL_DEV }}
          VITE_YOUTUBE_API_KEY: ${{ secrets.VITE_YOUTUBE_API_KEY }}
        run: npm run build

  # -------------------------
  # Push: build + deploy
  # -------------------------
  build-deploy:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Figure env (dev/prod) & targets
        id: vars
        run: |
          set -euo pipefail
          BR="${GITHUB_REF##*/}"
          if [ "$BR" = "main" ]; then
            echo "env_name=prod" >> $GITHUB_OUTPUT
            echo "s3_bucket=${{ vars.S3_BUCKET_FE_PROD }}" >> $GITHUB_OUTPUT
            echo "cf_dist=${{ vars.CF_DISTRIBUTION_ID_PROD }}" >> $GITHUB_OUTPUT
            echo "api=${{ vars.VITE_API_BASE_URL_PROD }}" >> $GITHUB_OUTPUT
            echo "oauth=${{ vars.VITE_OAUTH2_BASE_URL_PROD }}" >> $GITHUB_OUTPUT
          else
            echo "env_name=dev" >> $GITHUB_OUTPUT
            echo "s3_bucket=${{ vars.S3_BUCKET_FE_DEV }}" >> $GITHUB_OUTPUT
            echo "cf_dist=${{ vars.CF_DISTRIBUTION_ID_DEV }}" >> $GITHUB_OUTPUT
            echo "api=${{ vars.VITE_API_BASE_URL_DEV }}" >> $GITHUB_OUTPUT
            echo "oauth=${{ vars.VITE_OAUTH2_BASE_URL_DEV }}" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install
        run: npm ci --prefer-offline --no-audit --progress=false

      - name: Build
        env:
          VITE_API_BASE_URL: ${{ steps.vars.outputs.api }}
          VITE_OAUTH2_BASE_URL: ${{ steps.vars.outputs.oauth }}
          VITE_YOUTUBE_API_KEY: ${{ secrets.VITE_YOUTUBE_API_KEY }}
        run: npm run build

      - name: Verify dist exists
        run: |
          set -euo pipefail
          [ -d dist ] || { echo "dist/ not found. Build failed or output dir differs."; exit 1; }
          ls -la dist | head

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ vars.AWS_REGION_PROD }}

      - name: Verify required vars
        run: |
          set -euo pipefail
          [ -n "${{ steps.vars.outputs.s3_bucket }}" ] || { echo "Missing S3 bucket var"; exit 1; }
          [ -n "${{ steps.vars.outputs.cf_dist }}" ] || { echo "Missing CloudFront dist var"; exit 1; }

      - name: Upload assets to S3
        run: |
          set -euo pipefail
          cd dist

          aws s3 cp . "s3://${{ steps.vars.outputs.s3_bucket }}" --recursive \
            --exclude "*.html" \
            --cache-control "public,max-age=31536000,immutable"

          find . -name "*.html" -print0 | while IFS= read -r -d '' f; do
            aws s3 cp "$f" "s3://${{ steps.vars.outputs.s3_bucket }}/${f#./}" \
              --cache-control "no-cache" \
              --content-type "text/html; charset=utf-8"
          done

      - name: Invalidate CloudFront cache
        run: |
          set -euo pipefail
          aws cloudfront create-invalidation \
            --distribution-id "${{ steps.vars.outputs.cf_dist }}" \
            --paths "/index.html" "/"
